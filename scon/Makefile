.PHONY: scli bpfgen run

all: scli

scli: wormclient/generated/wormhole.pb.go
	@./build-scli.sh

wormclient/generated/wormhole.pb.go: ../wormhole/schema/wormhole.proto
	@go generate ./wormclient

# cat buffering improves speed a lot on virtiofs
bpf/vmlinux.h: /sys/kernel/btf/vmlinux
	@bpftool btf dump file /sys/kernel/btf/vmlinux format c | cat > bpf/vmlinux.h

bpf/bnat_%: bpf/src/bnat.c
	@go generate ./bpf

bpf/lfwd_%: bpf/src/lfwd.c
	@go generate ./bpf

bpf/pmon_%: bpf/src/pmon.c
	@go generate ./bpf

bpf/tproxy_%: bpf/src/tproxy.c
	@go generate ./bpf

bpfgen: bpf/bnat_bpfel.o bpf/bnat_bpfel.go bpf/lfwd_bpfel.o bpf/lfwd_bpfel.go bpf/pmon_bpfel.o bpf/pmon_bpfel.go bpf/tproxy_bpfel.o bpf/tproxy_bpfel.go

run:
	ssh -t ovm "cd /mnt/mac/$(shell pwd); killall scon; ./build.sh && ./run.sh"

run-cover:
	ssh -t ovm "cd /mnt/mac/$(shell pwd); killall scon; ./build.sh -cover && GOCOVERDIR=/mnt/mac/$(shell pwd)/cover ./run.sh"
