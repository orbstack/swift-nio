#!/usr/bin/env bash

#
# Copyright 2022-2023 Danny Lin <danny@kdrag0n.dev>. All rights reserved.
# 
# Unauthorized copying of this software and associated documentation files (the "Software"), via any medium, is strictly prohibited. Confidential and proprietary.
# 
# The above copyright notice shall be included in all copies or substantial portions of the Software.
#

set -uo pipefail
set -e

echo "[BEGIN] vinit-late"

sysctl -qp /etc/sysctl.conf

# swap
(
    # zram = 2x ram
    zram_mib=$(( $(cat /proc/meminfo | grep MemTotal | awk '{print $2}') / 1024 * 2 ))
    echo /dev/vdc1 > /sys/block/zram0/backing_dev
    echo "${zram_mib}M" > /sys/block/zram0/disksize
    echo huge_idle > /sys/block/zram0/writeback
    mkswap /dev/zram0
    swapon -d -p 32767 /dev/zram0
    sysctl vm.swappiness=100 vm.page-cluster=1
  
    # 1 gib emergency disk swap
    swapon -d -p 1 /dev/vdc2
) &
# 2 mib page reporting
echo 9 > /sys/module/page_reporting/parameters/page_reporting_order

# guest tools data
mount --bind /data/guest-state /opt/macvirt-guest/data

# guest tools
mount --rbind -o ro /opt/macvirt-guest /mnt/guest-tools

# setup docker rootfs
#

pushd /opt/docker-rootfs
# binds
mkdir -p /data/docker
mount --bind /data/docker var/lib/docker
popd

#
#

# resize fs
#xfs_growfs /dev/vdb1
btrfs filesystem resize max /data

# upgrade data: v3 -> v4
if [[ "$(cat /data/version)" -lt 4 ]]; then
    echo "[DATA pre-UPGRADE] v3 -> v4: start"

    set +e
    xfs_quota -x -c 'project -s -p /data/ 1' /data
    set -e

    sync
    echo "[DATA pre-UPGRADE] v3 -> v4: done"
fi

# ok to update quota/balloon now
mkdir -p /tmp/flags
touch /tmp/flags/data_resized
sync -f /data

# late nfs start because we need bind mount
mount -t tmpfs tmpfs -o noatime /Linux
# try to reduce nfs cpu usage
touch /Linux/.metadata_never_index /Linux/.metadata-never-index /Linux/.metadata_never_index_unless_rootfs
#TODO debug onlu
mkdir /Linux/data
mount --bind /data /Linux/data
# lock
mount -o remount,ro /Linux
rc-service nfs start
# vsock
/opt/vc/add-nfsd-vsock > /proc/fs/nfsd/portlist

echo "[END] vinit-late"
